<%- include('../partials/header', { titolo: 'Ricerca Eventi' }) %>
<div class="container mt-5">
  <div class="card shadow-sm">
    <div class="card-body">
      <h3 class="mb-4">Ricerca Eventi</h3>
      
      <!-- Messaggi di errore e successo -->
      <% if (locals.errore) { %>
        <div class="alert alert-danger"><%= errore %></div>
      <% } %>
      <% if (locals.successo) { %>
        <div class="alert alert-success"><%= successo %></div>
      <% } %>
      
      <!-- Form di ricerca -->
      <form action="/eventi/ricerca" method="GET" class="mb-4">
        <div class="row">
          <div class="col-md-8 mb-3">
            <label for="titolo" class="form-label">Cerca per titolo</label>
            <input type="text" name="titolo" id="titolo"
                   class="form-control"
                   placeholder="Inserisci il titolo dell'evento..."
                   value="<%= locals.req && locals.req.query && locals.req.query.titolo || '' %>">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">&nbsp;</label>
            <div class="d-grid">
              <button type="submit" class="btn btn-primary">üîç Cerca</button>
            </div>
          </div>
        </div>
      </form>
      
      <!-- Bottone nuovo evento -->
      <div class="d-grid gap-2 d-md-flex justify-content-md-end">
        <a href="/eventi/nuovo" class="btn btn-success">‚ûï Nuovo Evento</a>
      </div>
      
      <!-- Risultati della ricerca -->
      <% if (locals.eventi && Array.isArray(locals.eventi)) { %>
        <hr>
        <h4>Risultati della ricerca</h4>
        <% if (eventi.length === 0) { %>
          <div class="alert alert-info">Nessun evento trovato con i criteri specificati.</div>
        <% } else { %>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Titolo</th>
                  <th>Categoria</th>
                  <th>Data Inizio</th>
                  <th>Luogo</th>
                  <th>Azioni</th>
                </tr>
              </thead>
              <tbody>
                <% eventi.forEach(function(e) { %>
                  <tr>
                    <td><strong><%= e.titolo || 'N/A' %></strong></td>
                    <td><span class="badge bg-secondary"><%= e.categoria_descrizione || 'N/A' %></span></td>
                    <td><%= e.data_inizio ? new Date(e.data_inizio).toLocaleDateString('it-IT') : 'N/A' %></td>
                    <td><%= e.luogo || 'Non specificato' %></td>
                    <td>
                      <div class="btn-group btn-group-sm">
                        <a href="/eventi/<%= e.id_evento %>/modifica"
                           class="btn btn-outline-warning">‚úèÔ∏è Modifica</a>
                        <button onclick="eliminaEvento('<%= e.id_evento %>')"
                                class="btn btn-outline-danger">üóëÔ∏è Elimina</button>
                      </div>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } %>
      <% } %>
    </div>
  </div>
</div>

<script>
function eliminaEvento(id) {
  if (confirm('Sei sicuro di voler eliminare questo evento?')) {
    fetch(`/eventi/${id}/elimina`, { method: 'DELETE' })
      .then(function(response) {
        if (response.ok) {
          location.reload();
        } else {
          alert('Errore nell\'eliminazione dell\'evento');
        }
      })
      .catch(function(err) {
        console.error('Errore:', err);
        alert('Errore di connessione');
      });
  }
}
</script>

<%- include('../partials/footer') %>